<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\Relations\BelongsTo;

class Vulnerability extends Model
{
    protected $guarded = [];
    public function host()
    {
        return $this->belongsTo(Host::class);
    }



    public function scanHistory(): BelongsTo
    {
        return $this->belongsTo(ScanHistory::class);
    }







    //parsed_vulnerabilities
    public function getParsedVulnerabilitiesAttribute()
{
    $vulns = [];

    // Match CVEs or UUIDs followed by severity, URL, and optionally an exploit tag
    preg_match_all('/^\s*(?<id>CVE-\d{4}-\d+|[A-Z0-9:-]{6,})\s+(?<score>[\d.]+)\s+(?<url>https:\/\/[^\s]+)(\s+(?<tag>\*EXPLOIT\*))?/m', $this->vulnerability, $matches, PREG_SET_ORDER);

    foreach ($matches as $match) {
        $vulns[] = [
            'id'     => $match['id'],
            'score'  => (float) $match['score'],
            'url'    => $match['url'],
            'tag'    => $match['tag'] ?? null,
        ];
    }

    return $vulns;
}


}
